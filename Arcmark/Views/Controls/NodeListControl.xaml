<UserControl x:Class="Arcmark.Views.Controls.NodeListControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:Arcmark.ViewModels"
             mc:Ignorable="d"
             d:DesignHeight="400" d:DesignWidth="340">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Views/Templates/ThemeResources.xaml" />
            </ResourceDictionary.MergedDictionaries>
            <BooleanToVisibilityConverter x:Key="BoolToVis" />
        </ResourceDictionary>
    </UserControl.Resources>

    <!-- Outer grid for scroll shadows overlay -->
    <Grid>
        <!-- Scrollable node list -->
        <ScrollViewer x:Name="NodeScrollViewer"
                      Style="{StaticResource HiddenScrollViewerStyle}"
                      ScrollChanged="OnScrollChanged">
            <ItemsControl x:Name="NodeItems"
                          ItemsSource="{Binding Nodes, RelativeSource={RelativeSource AncestorType=UserControl}}"
                          VirtualizingPanel.IsVirtualizing="True"
                          VirtualizingPanel.VirtualizationMode="Recycling">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <VirtualizingStackPanel />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type vm:NodeViewModel}">
                        <!-- Node row -->
                        <Border x:Name="RowBorder"
                                Height="44"
                                Background="Transparent"
                                Padding="{Binding Indentation}"
                                MouseEnter="OnRowMouseEnter"
                                MouseLeave="OnRowMouseLeave"
                                MouseLeftButtonUp="OnRowClicked">
                            <Border.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="Rename"
                                              Command="{Binding RenameNodeCommand,
                                                        RelativeSource={RelativeSource AncestorType=UserControl}}"
                                              CommandParameter="{Binding Id}" />
                                    <MenuItem Header="Pin to top"
                                              Command="{Binding PinLinkCommand,
                                                        RelativeSource={RelativeSource AncestorType=UserControl}}"
                                              CommandParameter="{Binding Id}"
                                              Visibility="{Binding IsFolder,
                                                            Converter={StaticResource InverseBoolToVisibilityConverter}}" />
                                    <Separator />
                                    <MenuItem Header="Delete"
                                              Command="{Binding DeleteNodeCommand,
                                                        RelativeSource={RelativeSource AncestorType=UserControl}}"
                                              CommandParameter="{Binding Id}" />
                                </ContextMenu>
                            </Border.ContextMenu>

                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <!-- Folder chevron / favicon icon -->
                                <Grid Grid.Column="0" Width="22" VerticalAlignment="Center" Margin="0,0,6,0">

                                    <!-- Folder chevron -->
                                    <TextBlock x:Name="FolderChevron"
                                               Text="â–¶"
                                               FontSize="9"
                                               Foreground="{StaticResource DarkGrayBrush}"
                                               Opacity="0.5"
                                               VerticalAlignment="Center"
                                               HorizontalAlignment="Center"
                                               Cursor="Hand"
                                               MouseLeftButtonUp="OnFolderChevronClicked">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Collapsed" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsFolder}" Value="True">
                                                        <Setter Property="Visibility" Value="Visible" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding IsExpanded}" Value="True">
                                                        <Setter Property="RenderTransform">
                                                            <Setter.Value>
                                                                <RotateTransform Angle="90"
                                                                    CenterX="5" CenterY="5" />
                                                            </Setter.Value>
                                                        </Setter>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>

                                    <!-- Favicon (for links) -->
                                    <Image Width="16" Height="16"
                                           Source="{Binding Icon}"
                                           VerticalAlignment="Center"
                                           HorizontalAlignment="Center"
                                           RenderOptions.BitmapScalingMode="HighQuality">
                                        <Image.Style>
                                            <Style TargetType="Image">
                                                <Setter Property="Visibility" Value="Visible" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsFolder}" Value="True">
                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Icon}" Value="{x:Null}">
                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Image.Style>
                                    </Image>

                                    <!-- Globe placeholder (when no favicon) -->
                                    <TextBlock Text="ðŸŒ"
                                               FontSize="14"
                                               VerticalAlignment="Center"
                                               HorizontalAlignment="Center">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Collapsed" />
                                                <Style.Triggers>
                                                    <MultiDataTrigger>
                                                        <MultiDataTrigger.Conditions>
                                                            <Condition Binding="{Binding IsFolder}" Value="False" />
                                                            <Condition Binding="{Binding Icon}" Value="{x:Null}" />
                                                        </MultiDataTrigger.Conditions>
                                                        <Setter Property="Visibility" Value="Visible" />
                                                    </MultiDataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </Grid>

                                <!-- Display name (static) or rename TextBox -->
                                <TextBlock Grid.Column="1"
                                           Text="{Binding DisplayName}"
                                           VerticalAlignment="Center"
                                           FontFamily="{StaticResource AppFontFamily}"
                                           FontSize="13"
                                           Foreground="{StaticResource DarkGrayBrush}"
                                           TextTrimming="CharacterEllipsis">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="FontWeight" Value="Regular" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsFolder}" Value="True">
                                                    <Setter Property="FontWeight" Value="SemiBold" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding IsRenaming}" Value="True">
                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>

                                <!-- Inline rename TextBox -->
                                <TextBox Grid.Column="1"
                                         Text="{Binding DisplayName, Mode=TwoWay}"
                                         VerticalAlignment="Center"
                                         FontFamily="{StaticResource AppFontFamily}"
                                         FontSize="13"
                                         Background="Transparent"
                                         BorderThickness="0 0 0 1"
                                         BorderBrush="{StaticResource DarkGrayBrush}"
                                         Padding="0"
                                         LostFocus="OnRenameCommit"
                                         KeyDown="OnRenameKeyDown">
                                    <TextBox.Style>
                                        <Style TargetType="TextBox">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsRenaming}" Value="True">
                                                    <Setter Property="Visibility" Value="Visible" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBox.Style>
                                </TextBox>

                                <!-- Delete button (visible on hover) -->
                                <Button Grid.Column="2"
                                        Width="24" Height="24"
                                        Padding="0"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Cursor="Hand"
                                        Command="{Binding DeleteNodeCommand,
                                                  RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding Id}"
                                        Click="OnDeleteClicked">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsHovered}" Value="True">
                                                    <Setter Property="Visibility" Value="Visible" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                    <Button.Template>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="Bg" Background="Transparent" CornerRadius="6">
                                                <TextBlock Text="âœ•" FontSize="11"
                                                           Foreground="{StaticResource DarkGrayBrush}"
                                                           Opacity="0.5"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center" />
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="Bg" Property="Background">
                                                        <Setter.Value>
                                                            <SolidColorBrush Color="#1A000000" />
                                                        </Setter.Value>
                                                    </Setter>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Button.Template>
                                </Button>
                            </Grid>

                            <Border.Style>
                                <Style TargetType="Border">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsHovered}" Value="True">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <SolidColorBrush Color="#0F000000" />
                                                </Setter.Value>
                                            </Setter>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Top scroll shadow -->
        <Rectangle x:Name="TopShadow"
                   Height="24"
                   VerticalAlignment="Top"
                   IsHitTestVisible="False"
                   Opacity="0">
            <Rectangle.Fill>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="#30000000" Offset="0" />
                    <GradientStop Color="Transparent"   Offset="1" />
                </LinearGradientBrush>
            </Rectangle.Fill>
        </Rectangle>

        <!-- Bottom scroll shadow -->
        <Rectangle x:Name="BottomShadow"
                   Height="24"
                   VerticalAlignment="Bottom"
                   IsHitTestVisible="False">
            <Rectangle.Fill>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="Transparent"   Offset="0" />
                    <GradientStop Color="#30000000" Offset="1" />
                </LinearGradientBrush>
            </Rectangle.Fill>
        </Rectangle>
    </Grid>
</UserControl>
